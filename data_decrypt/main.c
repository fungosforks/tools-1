/*
 *   Program to encode text using RSA public key.
 *   *** For Demonstration use only *****
 *   Copyright (c) 1988-1997 Shamus Software Ltd.
 *
 *
 * ---
 *   Decode data with rsa private key by Efim Bushmanov
 * ---
 *
 *
 */


#include <stdio.h>

#include "include/miracl.h"
#include <stdlib.h>
#include <string.h>

int show_memory(char *mem, int len, char *text);

miracl *mip;


//
// public key to 'unsgin' signed data
//
char themagic_pub[0x80+1]=
"\xD8\x81\xDE\x8F\x79\x18\xDD\xFE\x68\x46\x80\xD7\xD0\xEB\x0C\x0A"
"\xAA\xF3\xED\xAC\xA9\xA4\x66\x7B\x7C\xFF\x16\xC3\x5A\x65\xDB\xA9"
"\x7C\xA2\xD6\xB7\x11\xE1\xFF\xA3\xEE\x85\xDF\xF1\x0D\x47\x5E\x31"
"\xE7\xF2\x91\x62\x20\x07\x00\x6B\x18\x31\xB7\x50\xC7\x21\xF4\xCB"
"\x6E\x5E\x51\xCE\xFD\x53\x16\x87\x03\xFB\x2E\xC0\x96\xDD\xFD\x7E"
"\x2D\xB4\xBC\xC4\xA4\x2D\x0E\x52\x9A\x2B\xBE\xCC\x34\xDC\x9C\x17"
"\xEB\xE3\x83\x1F\x55\x13\x75\xFF\xD0\xF1\x08\xA7\x8F\xFF\x81\xD5"
"\xC6\x95\x39\x12\xF0\xF0\x27\xF5\x21\xFA\xD8\x94\x65\x52\xDE\xF5"
;



/*
// my pkt example
char data[]=
"\x69\x3B\x16\xE3\xAA\xAE\xC8\xA7\x02\xE4\xC3\xB5\x00\x89\xFB\x9D"
"\x2E\x90\xEB\x55\xDC\x50\xD8\x0D\xC3\xBC\x0E\x80\x2D\xD6\x66\x0C"
"\x4B\x69\x10\x19\x20\x27\x8E\xCC\xDA\xC9\xBE\x1A\xB3\xDB\x13\x60"
"\xC1\x30\x91\xC6\x25\x50\xC0\x6B\xBB\xC3\x4F\x68\x5D\xEF\xA6\x39"
"\x16\x58\x6C\xE6\x1B\x94\xF2\x76\xBF\x93\x04\xF5\xAD\x70\x0B\x36"
"\x35\x65\x18\x3A\x03\x39\x52\xC3\x2F\xBE\xB2\xAD\x63\x08\xAC\xCD"
"\x89\xF4\xF1\x4C\xA6\xB1\xE0\x59\x9B\xBD\x3B\xD1\x24\xA5\xAF\xD0"
"\x6D\x2D\xD5\xA2\x5D\xB2\x6B\xD9\xA7\x4F\xB3\xFF\x78\x02\xD4\x10"
"\x05\xE8\x86\xD2\x9C\x05\x00\x06\xC7\xE5\xEB\x09\x00\x07\xD1\xFF"
"\xE3\xEC\x03\x03\x02\x54\x68\x69\x73\x20\x69\x73\x20\x4C\x4F\x4C"
"\x20\x6D\x73\x67\x2E\x00";
*/


// original skype pkt
char data[]=
"\x79\x8B\x83\xFC\xAE\x2D\x3A\x32\xD1\xE0\x37\x17\x7C\xE0\xE2\x57"
"\x6D\x9D\xE1\x49\x35\x50\x3C\x19\x31\x98\x51\x1C\xFF\xF5\x73\xA8"
"\x71\x74\x45\xD3\xB9\x44\xBE\x5D\x3A\xB2\x91\x0D\x1D\xE8\x9D\xB4"
"\x5B\x69\xCA\xB4\xAC\x60\xF7\xCC\x1B\xE4\x37\x01\xA1\x76\x8E\x33"
"\x03\x2C\x65\xCF\x47\xEE\xEF\xFB\xC1\x3D\xCB\xC8\x8C\xBE\x5F\xA8"
"\xD9\x54\x17\x6A\x31\x86\x14\x27\xC8\xC1\xC0\x28\x99\x3A\x65\xBE"
"\xD6\xCD\x09\xFE\xD9\x36\x61\x67\x22\x70\x68\x0A\x11\xED\xCD\x0F"
"\x9D\x88\xA1\xBC\xB6\x9C\x90\x61\xFB\x18\x2F\x24\xD0\x04\x22\xE4"
"\x00\x05\xB8\xFD\xCF\x9C\x05\x00\x06\xDB\xB2\x92\x0B\x00\x07\x82"
"\x85\x92\xC9\x02\x00\x44\x01\x03\x02\x74\x74\x74\x65\x73\x74\x31"
"\x00"
;



int rsa_unsign_data(char *buf, int len, char *outbuf) {  

    big e,m,kn;
	
	mip=mirsys(100,0);

    e=mirvar(0);
    m=mirvar(0);
    kn=mirvar(0);

    bytes_to_big(0x80,buf,m);
	bytes_to_big(0x80,themagic_pub,kn);

	power(m,65537,kn,e);
	
	big_to_bytes (0x80, e, outbuf, TRUE);

    return 0;
}



int decode_data(){
	unsigned char outbuf[0x100];
	int i;


	show_memory(data,0x80,"input data from pkt:");


	printf("Check signature using user pub key...\n");
	rsa_unsign_data(data, 0x80, outbuf);
	//show_memory(outbuf,0x80,"unsign data:");

	memcpy(data,outbuf,0x80);
	show_memory(data,sizeof(data),"All data together:");


	// prepare to show restored 41 blob

	// fill first bytes of hash with 00's
	memset(data,0x00,0x15);
	// first hash remove
	memset(outbuf,0x00,0x15);
	// second hash remove
	memcpy(data+0x15,outbuf,0x80-0x15);
	show_memory(data,sizeof(data),"All data together with cutted sha-1 hash:");

	main_unpack(data, sizeof(data));


	return 0;
};






int main(int argc, char* argv[]) {
	
	decode_data();

	printf("OK\n");

	return 0;
}

